!function(n){"function"==typeof define&&define.amd?define(n):n()}(function(){"use strict";function n(i,t,r=(()=>{})){i=e.castArray(i);const u=e.assign({$take:i.length,$ignore:[],$include:()=>({}),$keyName:"@",$value:"@"},t);i=f(i,u.$take);var s=e.omitBy(u,(n,e)=>"$"===e[0]);return l(i,(i,r,f)=>{let $=a(i,r);if(e.isFunction(t.$value)){for(let n in t.$value(i,r))s[n]="";i=t.$value(i,r)}u.$value=$(t.$value,i);u.$keyName=$(t.$keyName,r);let d=o(u.$value,u.$include,r);u.$value=d;for(let n in u.$include(i,r))s[n]="";u.$value=c(u.$value,u.$ignore);if(!e.isEmpty(u.$ignore)&&0==e.keys(s).length)for(let n in u.$value)s[n]="";if(!e.isObject(u.$value))return void f(u.$value,u.$keyName);l(s,(i,t,r)=>{function o(t){if(!e.isObject(i))return void r(t);c?n(t,i,n=>{n=e.isArray(t)?e.toArray(n):n[0];r(n)}):n([t],i,n=>{n=n[0];n=e.isArray(t)?e.toArray(n):n;r(n)})}let a=u.$value[t];let c=n.middlewares[t];c?n.middlewares[t].pass(a,n=>{o(n[0])}):o(a)},n=>{f(n,u.$keyName)},"@"!==u.$keyName?{}:[])},r,"@"!==u.$keyName?{}:[])}const e=require("lodash"),i=n=>{console.log(new Error(`Qreal [WARN] : ${n}`))},t=n=>e.isString(n)&&""!==n,r=(n,i=" ",t)=>{const r=e.fill(Array(t-n.length),i);return[...r,...n]},u=n=>e.isFunction(n)?n:()=>n,o=(n,t,r)=>{t=u(t)(n,r);t||i(`$include return "${t}"`);e.isString(n)?(e.isArray(t)&&(t=t.join("")),e.isEmpty(t)&&(t=""),n+=e.toString(t)):n=e.merge(n,t);return n},a=e.curry((n,i,r,o)=>{let a=u(r)(n,i);t(a)?(a=e.get(n,e.trimStart(a,"@"),null))||(a=o):a=o;return a}),c=(n,i)=>{if(e.isArray(n))return e.pullAll(n,i);if(e.isObject(n))return e.omit(n,i);return n},f=(n,i)=>{let t=e.take(e.castArray(i),2);let[u,o]=r(t,0,2);u=-1!==e.findIndex(n,u)?e.findIndex(n,u):u;o=u+o+t.length-1;return e.slice(n,u,o)},l=(n,e,i,t=[])=>{function r(){let i=a[o],r=n[i];e(r,i,(n,e)=>{o+=1;t[e||i]=n;u()})}function u(){o>a.length-1?i(t):r()}var o=0;let a=Object.keys(n);r();return t};n.middlewares={},n.use=function(e,t){Array.prototype.pass=function(t,r){l(n.middlewares[e],(n,r,u)=>{const o=n=>{"object"!=typeof n&&i(`middleware of ${e} should return Object`);u(n)};n(t).then?n(t).then(o):o(n(t))},r)},n.middlewares[e]?n.middlewares[e].push(t):n.middlewares[e]=[t]},module.exports=n});
