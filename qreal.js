!function(n){"function"==typeof define&&define.amd?define(n):n()}(function(){"use strict";function n(i,t,r=(()=>{})){i=e.isString(i)?i:e.castArray(i);const u=e.assign({$take:i.length,$ignore:[],$include:()=>({}),$keyName:"@",$value:"@"},t);i=f(i,u.$take);var l=e.omitBy(u,(n,e)=>"$"===e[0]);return s(i,(i,r,f)=>{let d=a(i,r);if(e.isFunction(t.$value)){for(let n in t.$value(i,r))l[n]="";i=t.$value(i,r)}u.$value=d(t.$value,i);u.$keyName=d(t.$keyName,r);let $=o(u.$value,u.$include,r);u.$value=$;for(let n in u.$include(i,r))l[n]="";u.$value=c(u.$value,u.$ignore);if(!e.isEmpty(u.$ignore)&&0==e.keys(l).length)for(let n in u.$value)l[n]="";if(!e.isObject(u.$value))return void f(u.$value,u.$keyName);s(l,(i,t,r)=>{function o(u){if(!e.isObject(i)){if(""!==i){let n=a(c,t);u=n(i,c)}return void r(u)}f?n(u,i,n=>{n=e.isArray(u)?e.toArray(n):n[0];r(n)}):(e.isArray(u)&&(u=[u]),n(u,i,n=>{e.isString(u)&&(n=[n.join("")]);n=n[0];if(e.isArray(c)){let i=e.toArray(n);0!==i.length&&(n=i)}r(n)}))}let c=u.$value[t];let f=n.middlewares[t];f?e.isArray(f)?f.pass(t,c,n=>{o(n[0])}):(n.middlewares=f,o(c)):o(c)},n=>{f(n,u.$keyName)},"@"!==u.$keyName?{}:[])},r,"@"!==u.$keyName?{}:[])}const e=require("lodash"),i=n=>{console.log(new Error(`Qreal [WARN] : ${n}`))},t=n=>e.isString(n)&&""!==n,r=(n,i=" ",t)=>{const r=e.fill(Array(t-n.length),i);return[...r,...n]},u=n=>e.isFunction(n)?n:()=>n,o=(n,t,r)=>{t=u(t)(n,r);t||i(`$include return "${t}"`);e.isString(n)&&(e.isArray(t)&&(t=t.join("")),e.isEmpty(t)&&(t=""),n+=e.toString(t));e.isObject(n)&&(n=e.merge(n,t));return n},a=e.curry((n,i,r,o)=>{let a=u(r)(n,i);t(a)?(a=e.get(n,e.trimStart(a,"@"),null))||(a=o):a=o;return a}),c=(n,i)=>{if(e.isArray(n))return e.pullAll(n,i);if(e.isObject(n))return e.omit(n,i);return n},f=(n,i)=>{let t=e.take(e.castArray(i),2);let[u,o]=r(t,0,2);u=-1!==e.findIndex(n,u)?e.findIndex(n,u):u;o=u+o+t.length-1;return e.slice(n,u,o)},s=(n,e,i,t=[])=>{function r(){let i=a[o],r=n[i];e(r,i,(n,e)=>{o+=1;t[e||i]=n;u()})}function u(){o>a.length-1?i(t):r()}var o=0;let a=Object.keys(n);r();return t};n.middlewares={},n.use=function(t,r){Array.prototype.pass=function(t,r,u){s(n.middlewares[t],(n,u,o)=>{const a=n=>{"object"!=typeof n&&i(`middleware of ${t} should return Object`);o(n)};if(e.isArray(r))return void s(r,(e,i,t)=>{t(n(e))},o);n(r).then?n(r).then(a):a(n(r))},u)},n.middlewares[t]?n.middlewares[t].push(r):e.set(n.middlewares,t,[r])},module.exports=n});
